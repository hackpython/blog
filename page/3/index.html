<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/blog/lib/pace/pace-theme-minimal.min.css">
  <script src="/blog/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://hackpython.github.io/blog').hostname,
    root: '/blog/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="HackPython，最酷的方式学习python">
<meta name="keywords" content="python,web,hack">
<meta property="og:type" content="website">
<meta property="og:title" content="HackPython">
<meta property="og:url" content="http:&#x2F;&#x2F;hackpython.github.io&#x2F;blog&#x2F;page&#x2F;3&#x2F;index.html">
<meta property="og:site_name" content="HackPython">
<meta property="og:description" content="HackPython，最酷的方式学习python">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://hackpython.github.io/blog/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>HackPython</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HackPython</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">HackPython</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hackpython.github.io/blog/blog/2019/10/21/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E7%A6%BB%E7%9C%9F%E6%AD%A3%E7%9A%84%E6%99%BA%E8%83%BD%E8%BF%98%E5%BE%88%E6%BC%AB%E9%95%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/header.jpeg">
      <meta itemprop="name" content="hackpython">
      <meta itemprop="description" content="HackPython，最酷的方式学习python">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HackPython">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/10/21/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E7%A6%BB%E7%9C%9F%E6%AD%A3%E7%9A%84%E6%99%BA%E8%83%BD%E8%BF%98%E5%BE%88%E6%BC%AB%E9%95%BF/" class="post-title-link" itemprop="url">人工智能离真正的智能还很漫长</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-21 16:42:04" itemprop="dateCreated datePublished" datetime="2019-10-21T16:42:04+08:00">2019-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-18 09:52:44" itemprop="dateModified" datetime="2019-11-18T09:52:44+08:00">2019-11-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>在跟非IT行业的朋友解释人工智能总是一个比较费劲的事情，他们对这块也有比较大的误区，本人虽然不是什么知名人士，但也从事过一段时间相关内容的学习与研究，本篇文章就尝试从较高的层面去讨论一下人工智能以及它目前的局限。</p>
<p>我会以我比较擅长的NLP(自然语言处理)领域作为例子，下面都是我个人观点，如有不对，还请斧正。</p>
<h2 id="当前人工智能的本质"><a class="markdownIt-Anchor" href="#当前人工智能的本质"></a> 当前人工智能的本质</h2>
<p>我们常说的人工智能通常指的是深度学习，因为近年大数据的兴起，让深度学习大展拳脚，但深度学习「理论层面的东西并没有大的突破」，依旧是旧的东西，本质依旧是概率论与统计学。</p>
<p>这里以微软小冰、苹果Siri这些智能助手为例，它们的技术原理其实都是对话系统+语音识别。当我们说一句话给小冰时，小冰此时做了什么？</p>
<p>小冰接收到这句话时，首先会进行语音识别，所谓语音识别就是利用它此前训练好的概率模型，计算这些语音数据对应了哪些文字，然后再进行对话预测，即这些文字下一句出现概率最大的文字是哪些，「小冰本身并没有理解我说的话，它只是通过计算概率给出回答」。</p>
<p>训练一个可以商用的聊天机器需要很多工程技巧的支撑，但本质就是概率模型这么回事，我们可以从微博上、从论坛上爬取大量的语料数据，这些数据是我们正常人类在网上留下的，进行复杂的预处理后，得到训练数据，而训练大致就是从这些数据中找到文字之间的规律。</p>
<p>举个例子，比如一个100T的语料中，出现了很多次「快来关注HackPython」这句话，那么模型就会记住「关注」这个词后大概率要接「HackPython」，但模型并没有理解这句话，它并不知道「HackPython」是一个公众号，并不知道「快来关注」是一种宣传表述，它知道的就只有概率。</p>
<p>NLP领域中，无论是「LSTM」、「GRU」，还是「注意力机制」，亦或是当前比较热门的「知识图谱」，都是基于文本在玩概率游戏，不同的方式只是在使用训练数据的信息时不同。</p>
<p>当前所有知名模型的本质都是如此，通过矩阵运算训练数据来获得某种概率分布，复杂模型的概率分布通常是高维的，这里又会引申出各种数学方法，如测度论、流形，但本质的思想依旧是想通过概率分布来描述训练数据的特征。有了这些，对于同类的数据，就可以使用相同的概率分布去描述，从而实现所谓的「识别」。</p>
<p>获得了概率分布后，其实还有问题缠绕着我们，如：为什么会训练出这样的概率分布？</p>
<p>这块对我们来说依旧是黑盒，我们也不知道这些数据通过这种模型训练后，为什么是这样的概率分布，即不可解释。</p>
<p>不可解释性的问题让深度学习在某些领域的使用受到一定的障碍，如金融领域，模型说这样投，大概率赚钱，但你无法严格的去证明这个结论的可靠性，只能直观的去解释，这就会让人犹豫，毕竟可能损失大量金钱。</p>
<p>同样的，自动驾驶也受到模型不可解释带来的困扰，自动驾驶依赖于图像识别技术。通过大量数据训练出的图像识别模型虽然有很高的识别率，但依旧存在问题，这点从「对抗攻击」领域的研究可以看出，当我们改变图像中少量的数据，图像识别模型就无法识别或识别错误。因为我们无法从数据层面去解释图像识别模型的概率分布，所以不清楚它在什么情况会失效。</p>
<h2 id="识别与理解的差异"><a class="markdownIt-Anchor" href="#识别与理解的差异"></a> 识别与理解的差异</h2>
<p>通过前面的讨论，可以知道，目前的深度学习做到的是「识别」，如语言识别、图像识别等，而并没有做到「理解」，这点从NLP领域可以很直观的看出，最智能的对话系统表现的依旧强差人意。</p>
<p>我们通过大量的数据的训练，在「识别」上已经有了不错的效果，这些效果已经可以产生很大的作用，比如人脸识别用于安检领域、车牌识别用于交通系统等等，「但关于理解的工作可能才刚刚开始」。</p>
<p>人工智能并不像我们想象的那么智能，无论是多么大的公司，推出多么先进的框架，什么自动调参、什么自动学习等牛逼的功能，本质都是如此，先进的框架只是让我们更快、更好的获得可以描述数据特征的概率分布，而这些概率分布并不能实现「理解」。</p>
<p>我们思考一下，人类是怎么做到「理解」的？</p>
<p>我们「理解」某个东西，通常指知道其背后抽象的概念，如「苹果」这个词，当我们看到这个词时，脑中会浮现出「苹果」相关的信息，这些信息并不来自「苹果」这个词，而是来自我曾经经历的生活，这些生活给了我们相应的背景知识，而这些背景知识让我们可以理解「苹果」这个词。</p>
<p>这些背景知识我们是怎么得到的？目前也还在研究。</p>
<p>这让很多学者开始质疑当前深度学习的研究路径是否正确，这里给出一个著名的讨论来展现当下我们训练模型的方式与自然界中真正学习方式的巨大差异。</p>
<p>日本的街头有很多乌鸦，研究人员发现这些乌鸦会偷坚果来吃，但乌鸦本身无法破开坚果的壳，那它们是怎么吃到坚果果肉的呢？它们在电线杆上观察十字路口的红绿灯，当红灯的时候，将坚果放在马路上，然后飞走，等绿灯，绿灯时，车流走过，将坚果果壳碾碎，当下次红灯时，乌鸦再飞过去悠闲的吃其中的果肉。</p>
<p>这件普通的事情表现了生物的学习其实只需要简单的观察就可以习得某个技能，这与深度学习学习方式完全不同，深度学习会利用大量的数据，然后反复的训练试错，使用试错获得的损失，利用梯度下降与反向传播的算法去更新模型，最终得到可以描述数据特征的概率分布，而乌鸦没有那么多命去试错，也没有那么多时间去试错。</p>
<p>可以说，乌鸦通过少量的观察「理解」了红绿灯的规律，而深度学习获得的模型无法做到。</p>
<p>自然界生物的学习方式与当前深度学习主流的学习方式之间具有的差异难以不让人疑惑。</p>
<h2 id="莫拉维克悖论"><a class="markdownIt-Anchor" href="#莫拉维克悖论"></a> 莫拉维克悖论</h2>
<p>1980 年汉斯・莫拉维克提到：要让电脑如成人般地下棋是相对容易的，但是要让电脑有如一岁小孩般的感知和行动能力却是相当困难甚至是不可能的。这便是著名的莫拉维克悖论(Moravec’s paradox)，这个悖论在当下依旧适用，简单而言，「困难的问题是简单的，简单的问题是困难的」是当下人工智能的处境。</p>
<p>对计算机而言，实现逻辑推理、数学运算等人类高级智慧只需要相对很少的计算能力，而实现感知、运动等低等级智慧却需要巨大的计算资源，这刚好与人类相反，对于感知、运动等，我们自身并不用费多少脑子就可以做好，而逻辑推导、数学计算这类问题却需要思考很久。</p>
<p>如何让人工智能具有「理解」能力？如何让人工智能对真实世界有基本的背景知识与反应？</p>
<p>当这两个问题解决了，我们才需要开始担心，人类会不会被人工智能取代。</p>
<p>但，深度学习带来的对数据特征的描述能力已经可以对一些职业产生致命的冲击，如工厂的工人，加了图像识别的机械臂可以很好的代替工人的大部分工作。</p>
<h2 id="尾"><a class="markdownIt-Anchor" href="#尾"></a> 尾</h2>
<p>如果你担心一种技术或某件事情会对自己的产生影响，最好的方法就是去了解它，弄明白它的原理，而不是看各种媒体文章，他们只能扰乱视线，增加游戏难度。知道原理后，无知带来的担忧就会消散，自己也可以做出相应的调整。</p>
<p>文章虽然主要从NLP的角度去讨论问题，但这些现象存在于不同的领域，如图像处理、强化学习等。</p>
<p>最后，感谢阅读。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hackpython.github.io/blog/blog/2019/10/21/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Celery/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/header.jpeg">
      <meta itemprop="name" content="hackpython">
      <meta itemprop="description" content="HackPython，最酷的方式学习python">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HackPython">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/10/21/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Celery/" class="post-title-link" itemprop="url">动手实现一个简单的Celery</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-10-21 16:41:49 / 修改时间：16:46:14" itemprop="dateCreated datePublished" datetime="2019-10-21T16:41:49+08:00">2019-10-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>Celery是一个由Python实现的分布式任务队列，任务队列通常有3个方面的功能。</p>
<ul>
<li>1.减缓高并发压力，先将任务写入队列，有空余资源再运行</li>
<li>2.执行定时任务，先将任务写入队列，指定时间下再执行</li>
<li>3.异步任务，web中存在耗时任务可以先将其写入队列，然后后台任务进程去执行</li>
</ul>
<p>已经有很多文章来描述Celery的用法与简单原理，本篇文章也会简单提及，但不会费太多笔墨。</p>
<p>本篇重点在于，利用Python动手实现一个简单的Celery，并使用自己实现的Celery实现异步任务，与上一篇「Python Web:Flask异步执行任务」一样，通过Flask构建一个简单的web，然后执行耗时任务，希望前端可以通过进度条显示任务的进度。</p>
<p>需注意，这里不会去解读Celery的源码，其源码具有很多工程细节，比较复杂，这里只是从其本质出发，简单的实现一个玩具Celery，这个玩具Celery在稳定性、效率等方面当然不能与Celery相比，但可以很好的理解Celery大体是怎么实现的。</p>
<p>本文讲究的是「形离神合」，与Celery实现细节不同，但本质原理相同。</p>
<p>那我们开始吧！</p>
<h2 id="celery的概念与原理"><a class="markdownIt-Anchor" href="#celery的概念与原理"></a> Celery的概念与原理</h2>
<p>Celery 5 个关键的概念，弄明白，就大致理解 Celery 了。</p>
<ul>
<li>
<p>1.Task(任务)<br />
简单而言就是你要做的事情，如用户注册流程中的发送邮件</p>
</li>
<li>
<p>2.Worker(工作者)<br />
在后台处理Task的人</p>
</li>
<li>
<p>3.Broker(经纪人)<br />
本质是一种队列，Task 会交给 Broker ，Worker 会从 Broker 中取 Task ，并处理</p>
</li>
<li>
<p>4.Beat<br />
定时任务调度器，根据定的时间，向 Broker 中添加数据，然后等待 Worker 去处理</p>
</li>
<li>
<p>5.Backend<br />
用于保存 Worker 执行结果的对象，每个 Task 都要有返回值，这些返回值，就在 Backend 中</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20190925100424.png" alt="" /></p>
<p>这里我们抛开这里的各种概念，从更本质的角度来看Celery，发现它就一个任务序列化存储与反序列化获取的过程。</p>
<p>以Web异步任务为例，使用方式通常为：</p>
<ul>
<li>1.有一个要长时间处理I/O的函数，如果不将其异步执行就会产生的阻塞，这通常是不被允许的</li>
<li>2.启动一个后台任务执行进程</li>
<li>3.当要执行耗时函数时，不会立刻同步运行，而是提取函数的关键数据，将其序列化存储到队列中，队列可以使用Redis或其他方式实现</li>
<li>4.后台任务执行进程会从队列中获取数据，并将其反序列化还原</li>
<li>5.后台任务执行进程会使用原来的函数以及还原的数据完成函数的执行，从而实现异步执行的效果。</li>
</ul>
<p>流程并不复杂，Celery中不同的概念分别负责上面流程中的不同部分。</p>
<h2 id="实现一个简单的celery"><a class="markdownIt-Anchor" href="#实现一个简单的celery"></a> 实现一个简单的Celery</h2>
<p>接着我们来实现一个Celery，这里Celery选择Redis作为后端。</p>
<p>先来整理一个大体的框架。</p>
<p>首先我们需要定义一个Task类来表示要执行的任务，不同的任务要执行的具体逻辑由使用者自身编写。</p>
<p>接着要定义一个任务队列，即Celery中的Broker，用于存储要执行的任务。</p>
<p>随后要定义执行进程Worker，Worker要从Broker中获取任务并去执行。</p>
<p>最后还需要定义一个用于存储任务返回数据的类，即Celery中的Backend。</p>
<p>看上去有点复杂，不慌，其实很简单。</p>
<h3 id="实现任务类"><a class="markdownIt-Anchor" href="#实现任务类"></a> 实现任务类</h3>
<p><a href="http://xn--task-ko8fn16c8ntmpwy41f.py" target="_blank" rel="noopener">首先来实现task.py</a>，用于定义任务相关的一些逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># task.py</span></span><br><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> broker <span class="keyword">import</span> Broker</span><br><span class="line"><span class="keyword">from</span> backend <span class="keyword">import</span> Backend</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseTask</span><span class="params">(abc.ABC)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Example Usage:</span></span><br><span class="line"><span class="string">        class AdderTask(BaseTask):</span></span><br><span class="line"><span class="string">            task_name = "AdderTask"</span></span><br><span class="line"><span class="string">            def run(self, a, b):</span></span><br><span class="line"><span class="string">                result = a + b</span></span><br><span class="line"><span class="string">                return result</span></span><br><span class="line"><span class="string">        adder = AdderTask()</span></span><br><span class="line"><span class="string">        adder.delay(9, 34)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    task_name = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.task_name:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"task_name should be set"</span>)</span><br><span class="line">        self.broker = Broker()</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @abc.abstractmethod # abstractmethod 派生类必须重写实现逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 写上你具体的逻辑</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">"Task `run` method must be implemented."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 更新任务状态</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_state</span><span class="params">(self, task_id, state, meta=&#123;&#125;)</span>:</span></span><br><span class="line">        _task = &#123;<span class="string">"state"</span>: state, <span class="string">"meta"</span>: meta&#125;</span><br><span class="line">        serialized_task = json.dumps(_task)</span><br><span class="line">        backend = Backend()</span><br><span class="line">        backend.enqueue(queue_name=task_id, item=serialized_task)</span><br><span class="line">        print(<span class="string">f"task info: <span class="subst">&#123;task_id&#125;</span> succesfully queued"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 异步执行</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delay</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.task_id = str(uuid.uuid4())</span><br><span class="line">            _task = &#123;<span class="string">"task_id"</span>: self.task_id, <span class="string">"args"</span>: args, <span class="string">"kwargs"</span>: kwargs&#125;</span><br><span class="line">            serialized_task = json.dumps(_task)</span><br><span class="line">            <span class="comment"># 加入redis中</span></span><br><span class="line">            self.broker.enqueue(queue_name=self.task_name, item=serialized_task)</span><br><span class="line">            print(<span class="string">f"task: <span class="subst">&#123;self.task_id&#125;</span> succesfully queued"</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="comment"># traceback.print_exc()</span></span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Unable to publish task to the broker."</span>)</span><br><span class="line">        <span class="keyword">return</span> self.task_id</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数据</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">async_result</span><span class="params">(task_id)</span>:</span></span><br><span class="line">    backend = Backend()</span><br><span class="line">    _dequeued_item = backend.dequeue(queue_name=task_id)</span><br><span class="line">    dequeued_item = json.loads(_dequeued_item)</span><br><span class="line">    state = dequeued_item[<span class="string">"state"</span>]</span><br><span class="line">    meta = dequeued_item[<span class="string">"meta"</span>]</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Info</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, state, meta)</span>:</span></span><br><span class="line">            self.state = state</span><br><span class="line">            self.meta = meta</span><br><span class="line">    info = Info(state, meta)</span><br><span class="line">    <span class="keyword">return</span> info</span><br></pre></td></tr></table></figure>
<p>上述代码中，定义了BaseTask类，它继承自python的abc.ABC成为一个抽象基类，其中一开始便要求必须定义task_name，这是因为后面我们需要通过task_name去找对应的任务队列。</p>
<p>BaseTask类的run()方法被abc.abstractmethod装饰，该装饰器会要求BaseTask的派生类必须重写run()方法，这是为了让使用者可以自定义自己的任务逻辑。</p>
<p>BaseTask类的update_state()方法用于更新任务的状态，其逻辑很简单，先将参数进行JSON序列化，然后调用Backend的enqueue()方法将数据存入，这里的Backend其实是Redis实例，enqueue()方法会将数据写入Redis的list中，需要注意，这里list的key为task_id，即当前任务的id。</p>
<p>BaseTask类的delay()方法用于异步执行任务，首先通过uuid为任务创建一个唯一id，然后将方法的参数通过JSON序列化，然后调用Broker的enqueue()将数据存入，这里的Broker其实也是一个Redis实例，enqueue()方法同样是将数据写入到Redis的list中，只是list的key为task_name，即当前任务的名称。</p>
<p>此外还实现了async_result()方法，该方法用于异步获取任务的数据，通过该方法可以获得任务的执行结果，或任务执行中的各种数据，数据的结构是有简单约定的，必须要有state表示当然任务的状态，必须要有meta表示当前任务的一些信息。</p>
<h3 id="实现broker与backend"><a class="markdownIt-Anchor" href="#实现broker与backend"></a> 实现Broker与Backend</h3>
<p>在task.py中使用了Broker与Backend，那接着就来实现一下这两个，先实现Broker。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># broker.py</span></span><br><span class="line"><span class="keyword">import</span> redis <span class="comment"># pip install redis</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Broker</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    use redis as our broker.</span></span><br><span class="line"><span class="string">    This implements a basic FIFO queue using redis.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        host = <span class="string">"localhost"</span></span><br><span class="line">        port = <span class="number">6379</span></span><br><span class="line">        password = <span class="literal">None</span></span><br><span class="line">        self.redis_instance = redis.StrictRedis(</span><br><span class="line">            host=host, port=port, password=password, db=<span class="number">0</span>, socket_timeout=<span class="number">8.0</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enqueue</span><span class="params">(self, item, queue_name)</span>:</span></span><br><span class="line">        self.redis_instance.lpush(queue_name, item)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dequeue</span><span class="params">(self, queue_name)</span>:</span></span><br><span class="line">        dequed_item = self.redis_instance.brpop(queue_name, timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> dequed_item:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        dequed_item = dequed_item[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> dequed_item</span><br></pre></td></tr></table></figure>
<p>没什么可讲的，就是定了两个方法用于数据的存储与读取，存储使用lpush方法，它会将数据从左边插入到Redis的list中，读取数据使用brpop方法，它会从list的右边取出第一个元素，返回该元素值并从list删除，左进右出就构成了一个队列。</p>
<p>为了简便，Backend的代码与Broker一模一样，只是用来存储任务的信息而已，代码就不贴了。</p>
<h3 id="后台任务执行进程worker"><a class="markdownIt-Anchor" href="#后台任务执行进程worker"></a> 后台任务执行进程Worker</h3>
<p>接着来实现后台任务执行进程Worker</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># worker.py</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Example Usage:</span></span><br><span class="line"><span class="string">        task = AdderTask()</span></span><br><span class="line"><span class="string">        worker = Worker(task=task)</span></span><br><span class="line"><span class="string">        worker.start()</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, task)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        self.task = task</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self,)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                _dequeued_item = self.task.broker.dequeue(queue_name=self.task.task_name)</span><br><span class="line">                dequeued_item = json.loads(_dequeued_item)</span><br><span class="line">                task_id = dequeued_item[<span class="string">"task_id"</span>]</span><br><span class="line">                task_args = dequeued_item[<span class="string">"args"</span>]</span><br><span class="line">                task_kwargs = dequeued_item[<span class="string">"kwargs"</span>]</span><br><span class="line">                task_kwargs[<span class="string">'task_id'</span>] = task_id</span><br><span class="line">                self.task.run(*task_args, **task_kwargs)</span><br><span class="line">                print(<span class="string">"succesful run of task: &#123;0&#125;"</span>.format(task_id))</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                print(<span class="string">"Unable to execute task."</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>上述代码中，定义了Worker类，Worker类在初始化时需要指定具体的任务实例，然后从broker中获取任务相关的数据，接着调用其中的run()方法完成任务的执行，比较简单。</p>
<h3 id="使用玩具celery"><a class="markdownIt-Anchor" href="#使用玩具celery"></a> 使用玩具Celery</h3>
<p>玩具Celery的关键结构都定义好了，接着就来使用一下它，这里依旧会使用「Python Web:Flask异步执行任务」文章中的部分代码，如前端代码，这里也不再讨论其前端代码，没有阅读可以先阅读一下，方便理解下面的内容。</p>
<p>首先定义出一个耗时任务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LongTask</span><span class="params">(BaseTask)</span>:</span></span><br><span class="line"></span><br><span class="line">    task_name = <span class="string">"LongTask"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, task_id)</span>:</span></span><br><span class="line">        <span class="string">"""Background task that runs a long function with progress reports."""</span></span><br><span class="line">        verb = [<span class="string">'Starting up'</span>, <span class="string">'Booting'</span>, <span class="string">'Repairing'</span>, <span class="string">'Loading'</span>, <span class="string">'Checking'</span>]</span><br><span class="line">        adjective = [<span class="string">'master'</span>, <span class="string">'radiant'</span>, <span class="string">'silent'</span>, <span class="string">'harmonic'</span>, <span class="string">'fast'</span>]</span><br><span class="line">        noun = [<span class="string">'solar array'</span>, <span class="string">'particle reshaper'</span>, <span class="string">'cosmic ray'</span>, <span class="string">'orbiter'</span>, <span class="string">'bit'</span>]</span><br><span class="line"></span><br><span class="line">        message = <span class="string">''</span></span><br><span class="line">        total = random.randint(<span class="number">10</span>, <span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(total):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> message <span class="keyword">or</span> random.random() &lt; <span class="number">0.25</span>:</span><br><span class="line">                message = <span class="string">'&#123;0&#125; &#123;1&#125; &#123;2&#125;...'</span>.format(random.choice(verb),</span><br><span class="line">                                                  random.choice(adjective),</span><br><span class="line">                                                  random.choice(noun))</span><br><span class="line">            self.update_state(task_id=task_id, state=<span class="string">'PROGRESS'</span>,</span><br><span class="line">                              meta=&#123;<span class="string">'current'</span>: i, <span class="string">'total'</span>: total,</span><br><span class="line">                                    <span class="string">'status'</span>: message&#125;)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        self.update_state(task_id=task_id, state=<span class="string">'FINISH'</span>, meta=&#123;<span class="string">'current'</span>:<span class="number">100</span>, <span class="string">'total'</span>: <span class="number">100</span>,<span class="string">'status'</span>: <span class="string">'Task completed!'</span>, <span class="string">'result'</span>:<span class="number">32</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<p>每个耗时任务都要继承在BaseTask并且重写其run()方法，run()方法中的逻辑就是当前这个耗时任务要处理的具体逻辑。</p>
<p>这里逻辑其实很简单，就是随机的从几个列表中抽取词汇而已。</p>
<p>在for迭代中，想要前端知道当前任务for迭代的具体情况，就需要将相应的数据通过BaseTask的update_state()方法将其更新到backend中，使用task_id作为Redis中list的key。</p>
<p>当逻辑全部执行完后，将状态为FINISH的信息存入backend中。</p>
<p>写一个接口来触发这个耗时任务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="meta">@app.route('/longtask', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">longtask</span><span class="params">()</span>:</span></span><br><span class="line">    long_task = LongTask()</span><br><span class="line">    task_id = long_task.delay()</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;&#125;), <span class="number">202</span>, &#123;<span class="string">'Location'</span>: url_for(<span class="string">'taskstatus'</span>,</span><br><span class="line">                                                  task_id=task_id)&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑非常简单，实例化LongTask()，并调用其中的delay()方法，该方法会将当前任务存入认为队列中，当前的请求会将当前任务的task_id通过响应包头的中的taskstatus字段传递给前端。</p>
<p>前端获取到后，就可以通过task_id去获取当前任务执行状态等信息，从而实现前端的可视化。</p>
<p>接着定义相应的接口来获取当前任务的信息，调用用async_result()方法，将task_id传入则可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># app.py</span><br><span class="line">@app.route(&apos;/status/&lt;task_id&gt;&apos;)</span><br><span class="line">def taskstatus(task_id):</span><br><span class="line">    info = async_result(task_id)</span><br><span class="line">    print(info)</span><br><span class="line">    if info.state == &apos;PENDING&apos;:</span><br><span class="line">        response = &#123;</span><br><span class="line">            &apos;state&apos;: info.state,</span><br><span class="line">            &apos;current&apos;: 0,</span><br><span class="line">            &apos;total&apos;: 1,</span><br><span class="line">            &apos;status&apos;: &apos;Pending...&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    elif info.state != &apos;FAILURE&apos;:</span><br><span class="line">        response = &#123;</span><br><span class="line">            &apos;state&apos;: info.state,</span><br><span class="line">            &apos;current&apos;: info.meta.get(&apos;current&apos;, 0),</span><br><span class="line">            &apos;total&apos;: info.meta.get(&apos;total&apos;, 1),</span><br><span class="line">            &apos;status&apos;: info.meta.get(&apos;status&apos;, &apos;&apos;)</span><br><span class="line">        &#125;</span><br><span class="line">        if &apos;result&apos; in info.meta:</span><br><span class="line">            response[&apos;result&apos;] = info.meta[&apos;result&apos;]</span><br><span class="line">    else:</span><br><span class="line">        # something went wrong in the background job</span><br><span class="line">        response = &#123;</span><br><span class="line">            &apos;state&apos;: info.state,</span><br><span class="line">            &apos;current&apos;: 1,</span><br><span class="line">            &apos;total&apos;: 1,</span><br><span class="line">            &apos;status&apos;: str(info.meta),  # this is the exception raised</span><br><span class="line">        &#125;</span><br><span class="line">    return jsonify(response)</span><br><span class="line">```        </span><br><span class="line"></span><br><span class="line">最后，需要定义一个启动后台任务执行进程的逻辑</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line"># run_worker.py</span><br><span class="line">from worker import Worker</span><br><span class="line">from app import LongTask</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    long_task = LongTask()</span><br><span class="line">    worker = Worker(task=long_task)</span><br><span class="line">    worker.start()</span><br><span class="line">```                  </span><br><span class="line"></span><br><span class="line">至此，整体结构就构建完了，使用一下。</span><br><span class="line"></span><br><span class="line">首先运行redis。</span><br></pre></td></tr></table></figure>
<p>redis-server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后运行Flask。</span><br></pre></td></tr></table></figure>
<p>python <a href="http://app.py" target="_blank" rel="noopener">app.py</a></p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">最后启动一下后台任务执行进程，它相当于Celery的`celery -A xxx worker --loglevel=info`命令。</span><br></pre></td></tr></table></figure>
<p>python run_worker.py</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">同时执行多个任务，效果如下</span><br><span class="line"></span><br><span class="line">![](https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/ayuLiao/im</span>ages<span class="regexp">/master/</span><span class="number">20190925094458</span>.png)</span><br><span class="line"></span><br><span class="line">对应的一些打印如下：</span><br></pre></td></tr></table></figure>
<p>python run_worker.py<br />
Unable to execute task.<br />
Unable to execute task.<br />
Unable to execute task.<br />
task info: 3c7cd8ac-7482-467b-b17c-dba2649b70ee succesfully queued<br />
task info: 3c7cd8ac-7482-467b-b17c-dba2649b70ee succesfully queued<br />
task info: 3c7cd8ac-7482-467b-b17c-dba2649b70ee succesfully queued<br />
task info: 3c7cd8ac-7482-467b-b17c-dba2649b70ee succesfully queued</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>python <a href="http://app.py" target="_blank" rel="noopener">app.py</a></p>
<ul>
<li>
<p>Serving Flask app “app” (lazy loading)</p>
</li>
<li>
<p>Environment: production<br />
WARNING: Do not use the development server in a production environment.<br />
Use a production WSGI server instead.</p>
</li>
<li>
<p>Debug mode: on</p>
</li>
<li>
<p>Running on <a href="http://127.0.0.1:5000/" target="_blank" rel="noopener">http://127.0.0.1:5000/</a> (Press CTRL+C to quit)</p>
</li>
<li>
<p>Restarting with stat</p>
</li>
<li>
<p>Debugger is active!</p>
</li>
<li>
<p>Debugger PIN: 145-285-706<br />
127.0.0.1 - - [25/Sep/2019 11:14:07] “GET / HTTP/1.1” 200 -<br />
task: 3c7cd8ac-7482-467b-b17c-dba2649b70ee succesfully queued<br />
127.0.0.1 - - [25/Sep/2019 11:14:11] “POST /longtask HTTP/1.1” 202 -<br />
&lt;task.async_result.<locals>.Info object at 0x107f50780&gt;<br />
127.0.0.1 - - [25/Sep/2019 11:14:11] “GET /status/3c7cd8ac-7482-467b-b17c-dba2649b70ee HTTP/1.1” 200 -<br />
&lt;task.async_result.<locals>.Info object at 0x107f50a20&gt;<br />
127.0.0.1 - - [25/Sep/2019 11:14:13] “GET /status/3c7cd8ac-7482-467b-b17c-dba2649b70ee HTTP/1.1” 200 -</p>
</li>
</ul>
<pre class="highlight"><code class="">
## 尾

需要注意一些，上面的代码中，使用Worker需要实例化具体的任务，此时任务实例与app.py中通过接口创建的任务实例是不同的，Worker利用不同的实例，使用相同的参数，从而实现执行效果相同的目的。

代码已上传Githu：https://github.com/ayuLiao/toy_celery

如果你觉得文章有帮助，请按一下右下角的「在看」小星星，那是可以按的，谢谢。




</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hackpython.github.io/blog/blog/2019/10/21/%E4%B8%8D%E5%A6%82%E5%90%83%E8%8C%B6%E5%8E%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/header.jpeg">
      <meta itemprop="name" content="hackpython">
      <meta itemprop="description" content="HackPython，最酷的方式学习python">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HackPython">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/10/21/%E4%B8%8D%E5%A6%82%E5%90%83%E8%8C%B6%E5%8E%BB/" class="post-title-link" itemprop="url">不如吃茶去</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-10-21 16:41:31 / 修改时间：16:46:37" itemprop="dateCreated datePublished" datetime="2019-10-21T16:41:31+08:00">2019-10-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>这是一篇没什么用的随笔。</p>
</blockquote>
<p>我写文章的时候喜欢泡茶喝，这个习惯不知道什么时候开始有的，喝茶会让我内心更加平和，手指在键盘上飞舞时也更加灵动。</p>
<p>我不懂茶，只是喜欢那种「纯」的感觉，这种感觉是模糊的，并不透彻，我也难以用文字将其描述清楚，但喝了一口，人就会静下来。</p>
<p>相比于喝西洋咖啡，茶会多出一种文化的厚重感，这很有可能是心理作用。</p>
<p>闲来无事泡茶喝，脑中总会时不时浮现武侠高人煮茶笑谈天下的画面，便会有向往之情。</p>
<p>我泡茶十分随意，既不讲究水的使用，也不讲究茶叶的使用，更不讲究茶具的时候，电磁壶烧一壶热水，茶饼掰上小块，放入廉价的茶壶中，水入茶成，在热气腾腾之际，小品一口，将热气呼出，心神畅快。</p>
<p>凡喝茶之人定听过洗茶一说，所谓先洗而后饮之，所以我泡茶也会装模作样，先洗后饮，但洗茶其实并不一定能洗取茶中之杂物。</p>
<p>据查，洗茶出于北宋，主要用于洗去散茶表面杂质，从而诱发茶的香与味，但我总感觉洗茶一事形式意义大于实际意义，大多数工艺生产的茶叶，其污垢可能难以通过洗茶去除。</p>
<p>我自己偶尔会外出买一些茶，但通常会选择普洱茶饼，回想以前不喝茶时，买了两个2005年的普洱茶饼，本想带回给父亲喝，但他却不要，儿时自己对父亲的一个印象是喜喝茶，因为平常去看他，都有泡茶喝，万万没想到，他并不喜欢，只是没啥可喝，别人又送了很多茶，才泡来喝，他喜喝的应该是啤酒，所以两个茶饼只能自己享用。</p>
<p>我此前买茶多买铁盒子装的散茶，当时是我第一次买茶饼，喝了之后，感觉味道更浓郁，就喜欢上了。</p>
<p>前段时间，小青柑比较流行，也买了一盒回来喝，小青柑的味道比较特别，茶中含有青柑之味，喝起来会有青涩之感，偶尔泡来提神也是极佳的，唯有不足就是，一个小青柑对于我的廉价茶壶而言太大了，很多时候，泡一壶会有很重的茶与青柑之味，此时茶已非茶，过于浓郁的茶，喝起来难以让人喜欢。</p>
<p>现在我最常泡的茶其实并不是茶饼之茶，而是泰式手标茶，说来也巧，当时泰国之行，只是顺带买了一盒回来，并没有对其抱有什么期待，毕竟在我的印象中，泰国并不算一个有茶文化的国家，但买回来喝却别有一番味道。</p>
<p>泰式手标茶通常是袋装的，要泡时，直接取出一袋茶叶，往壶中一放，加水即可成茶，这种茶会带有微甜之味，而缺少茶本来的淡苦，甜味时常会让人感到愉悦，但苦涩有时也很重要。</p>
<p>那混着喝？我女友有时确实会混合着泡，但我个人并没有那么喜欢。</p>
<p>说来惭愧，品茶之友常言：「茶里乾坤大，壶中日月长」，我虽常喝茶，但连门径都未曾窥得。</p>
<p>茶道历史悠久，我有时会问自己，是否也要学一学茶道？</p>
<p>此前我一直以为茶道源于中国，但后来发现「中国无茶道，茶道源于日本，中国有的是茶艺。」</p>
<p>对我们中国人而言，茶只是开门七事之一：柴米油盐酱醋茶，它只是一个很生活化的东西，而「道」在传统文化中是很神圣的，所谓得道便可升仙，没人会将如此生活化的东西称为道，也没人会将自己高超的技艺称为道。</p>
<p>在传统文化中，对某人高超技艺最高的褒奖就是「技近乎道」(出自&lt;庄子-养生篇&gt;，「庖丁解牛，技进乎道」)，所以我们更多将其称为「术」或「艺」，而很少称为「道」，而日本很喜欢定义各种道，但感觉更多只是喜欢那种仪式感以及那种仪式感创造出的氛围。</p>
<p>虽说中国无茶道，但却是丰厚茶文化的起源地，这其实才是茶道、茶艺的核心，其他的只是名词之争。</p>
<p>懂茶文化的人与我这种不懂茶文化的人，虽然都喝茶，但喝的肯定不是一种茶，这很好理解，懂音乐的听音乐会，懂艺术的鉴赏名画，跟不懂的人感受到肯定是不一样的。</p>
<p>如何获得这种高级体验呢？</p>
<p>这个话题太深刻了，此次不聊，吃茶去了。</p>
<p>对了，你平时喜欢喝什么茶呢？</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hackpython.github.io/blog/blog/2019/10/21/%E8%AF%A6%E8%A7%A3Python-import%E6%9C%BA%E5%88%B6-%E4%B8%80-import%E4%B8%AD%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/header.jpeg">
      <meta itemprop="name" content="hackpython">
      <meta itemprop="description" content="HackPython，最酷的方式学习python">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HackPython">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/10/21/%E8%AF%A6%E8%A7%A3Python-import%E6%9C%BA%E5%88%B6-%E4%B8%80-import%E4%B8%AD%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" class="post-title-link" itemprop="url">详解Python import机制(一):import中的基本概念</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-21 16:41:18" itemprop="dateCreated datePublished" datetime="2019-10-21T16:41:18+08:00">2019-10-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hackpython.github.io/blog/blog/2019/10/21/%E8%AF%A6%E8%A7%A3Python-import%E6%9C%BA%E5%88%B6-%E4%BA%8C-%E7%BB%9D%E5%AF%B9%E5%AF%BC%E5%85%A5%E4%B8%8E%E7%9B%B8%E5%AF%B9%E5%AF%BC%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/header.jpeg">
      <meta itemprop="name" content="hackpython">
      <meta itemprop="description" content="HackPython，最酷的方式学习python">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HackPython">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/10/21/%E8%AF%A6%E8%A7%A3Python-import%E6%9C%BA%E5%88%B6-%E4%BA%8C-%E7%BB%9D%E5%AF%B9%E5%AF%BC%E5%85%A5%E4%B8%8E%E7%9B%B8%E5%AF%B9%E5%AF%BC%E5%85%A5/" class="post-title-link" itemprop="url">详解Python import机制(二):绝对导入与相对导入</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-21 16:41:06" itemprop="dateCreated datePublished" datetime="2019-10-21T16:41:06+08:00">2019-10-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hackpython.github.io/blog/blog/2019/10/21/%E4%B8%80%E8%87%B4%E6%80%A7Hash%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/header.jpeg">
      <meta itemprop="name" content="hackpython">
      <meta itemprop="description" content="HackPython，最酷的方式学习python">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HackPython">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/10/21/%E4%B8%80%E8%87%B4%E6%80%A7Hash%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">一致性Hash算法</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-10-21 16:40:44 / 修改时间：16:47:12" itemprop="dateCreated datePublished" datetime="2019-10-21T16:40:44+08:00">2019-10-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>本节简单讨论一下Hash(哈希)算法以及它的常见应用场景，之所以写此篇，是因为在群里看见相关的讨论。</p>
<p>Hash算法与一致性Hash其使用范围是很广泛的，本文抛砖引玉一下。</p>
<h2 id="hash算法"><a class="markdownIt-Anchor" href="#hash算法"></a> Hash算法</h2>
<p>什么是Hash算法？</p>
<p>一句话定义，将任意长度的二进制数据映射成固定长度的二进制值串，这种映射规则就是哈希算法。</p>
<p>想重头设计一个优秀Hash算法并不容易，它需要满足一些基本条件</p>
<ul>
<li>1.不可逆，无法通过Hash算法处理过的二进制值(哈希值)串反推出原始值</li>
<li>2.数据敏感，原始数据有一些微小的变化都会让Hash后的二进制值出现较大变化</li>
<li>3.冲突尽量小，根据「鸽巢原理」，任何Hash算法都不可能完全没有冲突，但优秀的Hash算法会让冲突的概率很小</li>
<li>4.效率高，Hash算法要可以比较高效的计算出哈希值</li>
</ul>
<p>什么是鸽巢原理？</p>
<p>很简单，总共只有10个巢，但却有11只鸽子，那么肯定会出现两个鸽子在同一个巢的情况。</p>
<p>引申到Hash算法中，因为Hash算法要将任意长度的二进制值都映射成固定长度的哈希值，固定长度哈希值其变化是有限的，而任意长度的原始数据是无限的，相当于有限的鸽巢与无限的鸽子，所以任意Hash算法在理论上都是无法避免冲突的，但Hash算法生成的哈希值越长，冲突的概率越小，但要生成越长的哈希值，需要的运算时间也就越长。</p>
<p>常见的Hash算法有很多，如MD5、SHA、AES等等</p>
<p>Hash算法有很多应用场景，如作为唯一标识、给密码安全加密等等，但为了配合文章主题，这里主要从分布式这个方向来讨论。</p>
<p>一个经典的问题：现在图库中有1亿张图片，你怎么可以快速判断某张图片是否存在于图库中？</p>
<h2 id="取模应用"><a class="markdownIt-Anchor" href="#取模应用"></a> 取模应用</h2>
<p>思考一下1亿图片图库是否存在某图片的问题。</p>
<p>1亿张图片，单台物理机没戏，所以需要多台物理机配合才能处理这种规模的数据。</p>
<p>具体怎么做？</p>
<p>先准备n台物理机，每台物理机只维护部分图片对应的散列表(利用散列算法，通过key可以快速找到value的一种数据结构)，我们每次从图库中读取一张图片，都利用Hash算法计算唯一标识，并利用这个唯一表示构建散列表的key，但问题是，一张图片的信息放在哪个物理机中呢？</p>
<p>搭建一个redis，如根据图片名称，如图片名称以1结尾的，放到1号物理机，其他的类推？这种方式并不好，最好的方式就是利用哈希与取模，具体做法如下：</p>
<p>我们每次从图库中取一张图片，利用Hash算法获得哈希值，这相当于图片的唯一标识，利用它与机器的个数n进行求余运算，取其模作为作为要操作物理机的编号，假设取模获得的值是x，则将图片的唯一标识与路径存放在第x个物理机中。</p>
<p>而查询一种图片是否存在图库中，其过程也类似，先对图片做Hash，获得哈希值后，求余取模获得对应的物理机编号，再去这台物理机，通过散列表判断这个哈希值是否存在，从而就可以判断图片是否存在。</p>
<p>通过上面的结构，就可以快速判断1亿图片图库是否存在某图片了。</p>
<p>这里再讨论一下1亿张图片大概需要多少物理机。</p>
<p>假设我们通过MD5处理，获得图片的MD5值，这个值会占128bit，即16字节，而文件路径长度上限为256字节，因为散列表会出现冲突的可能，所以还需要利用链表来解决冲突，而列表的指针预估占8个字节，这里对文件路径占的字节数取平均值来估算，一张图片构建散列表元素的大小大约需要152字节(256/2+16+8)。</p>
<p>一台物理机，内存如果为2GB，那么大概可以处理1400万张图片(2GB/152字节)，那处理1亿张图片，需要十几台物理机，这里还没有涉及装载因子的概念，所谓装载因子是指散列表中的数据超过装载因子定义的值，就需要进行扩容了。</p>
<blockquote>
<p>散列表:可以通过数组的方式来简单理解散列表，数组可以通过下标找到对应的值，其时间复杂度为O(1)，散列表也是如此，散列表会申请一段内存连续内存空间，然后通过散列函数获得下标，这个下标就可以定位出该内存空间的某个位置，其时间复杂度也为O(1)，散列函数没有Hash函数那么复杂，它只要求算法可以将对应的值比较平均的分配到对应的内存空间则可。</p>
</blockquote>
<h2 id="一致性hash"><a class="markdownIt-Anchor" href="#一致性hash"></a> 一致性Hash</h2>
<p>如果加多或减少一个物理机呢？</p>
<p>比如图库应用上线后，效果不错，图库图片增多到了1.1亿张了，此时就要增加物理机了，只是简单的增加一台物理机吗？</p>
<p>为了描述清楚，这里将情况简化一下，比如有2000万张图片在图库中，它们通过Hash函数求余取模的方式在两台物理机上构建了散列表，但此时图片增加到了3000w张，要增加多一台，此时就会出现取余求模的值发生变化。</p>
<p>原本，2台物理机时：Hash(a.jpg)%2 = 1</p>
<p>现在，3台物理机时：Hash(a.jpg)%3 = ???</p>
<p>可以发现，增加一台物理机后，原本构建的散列表也都失效了，需要对所有的3000w张图片进行Hash计算，重新构建散列表，这是非常不现实的。</p>
<p>这也是造成缓存雪崩的原因之一。</p>
<p>所谓缓存雪崩，当服务器增加时，此前的缓存全部失效，导致请求直接到达底层数据库，请求量一大，会让底层数据库崩溃，出现灾难性后果。</p>
<p>那怎么办？</p>
<p>使用一致性Hash则可。</p>
<p>解释一下一致性Hash，比如某种Hash算法，它映射出的哈希值有2<sup>32种取值可能(比如MD5，有2</sup>128种取值可能)，此时我们就可以构建出一个虚拟的哈希环</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191014231820.png" alt="" /></p>
<p>哈希环从0开始，顺时针方向增大，0的右侧第一个点表示1，以此类推，最后一个点位2^32-1，在0左侧第一个，哈希环上就表示了当前这种Hash算法所有可能的值。</p>
<p>接着利用Hash算法对服务器的特征值进行哈希运算，获得唯一的哈希值，这里可以选择服务器的IP或主机名等关键字段，此时，服务器对应的哈希值就会出现到哈希环上。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191014232014.png" alt="" /></p>
<p>回答一开始的图片问题，当一张图片来后，先计算其哈希值，然后将其放置到哈希环上，并沿着哈希环顺时针行走，其遇到的第一台服务器就是它要存储的服务器。</p>
<p>这就是一致性Hash的所有过程。</p>
<p>当某个服务器宕机了，此时，不需要对所有图像数据都重新进行Hash运算并构建新的散列表，而只需对宕机服务器中的数据进行上述操作。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191014232335.png" alt="" /></p>
<p>如果数据量增大，需要新增服务器，此时也不需要操作所有的数据。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191014232514.png" alt="" /></p>
<p>一致性Hash算法不像此前的求余取模方法，服务器数量的变动只会影响到部分服务器的数据，而不会影响全局数据。</p>
<h2 id="虚拟节点"><a class="markdownIt-Anchor" href="#虚拟节点"></a> 虚拟节点</h2>
<p>接着讨论一下虚拟节点的概念。</p>
<p>进行一致性Hash时，如果服务器太少，比如只有两台服务器，此时就容易出现数据倾斜，即大部分数据都让其中某一台服务器处理了。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191014232706.png" alt="" /></p>
<p>为了避免这种情况，就提出了虚拟节点的概念。</p>
<p>简单而言，就是为一台服务器构建多个逻辑上的节点，比如在服务器的IP后引入编号，从而获得不同的哈希值，这些哈希值都落在哈希环上构成虚拟节点，然后维护一张简单的映射表，保存虚拟节点与真实服务器之间的关系。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191014233034.png" alt="" /></p>
<p>真实数据依旧以同样的操作获得哈希值，然后落在哈希环上，只是它们遇到虚拟节点就停下来了，并将具体的数据交由虚拟节点对应的真实服务器去处理。</p>
<p>在实际应用中，虚拟节点设置的比较大，从而让少量的服务器也可以做相对均衡的数据分布处理。</p>
<h2 id="尾"><a class="markdownIt-Anchor" href="#尾"></a> 尾</h2>
<p>本人最近在恶补算法、计算机组成原理方面的知识以及在学习C++语言，所以更新的并不频繁。</p>
<p>希望在写公众号的这段时间里，与大家一同学习进步。</p>
<p>最后，如果内容对你有帮助，麻烦点一下「好看」，那是可以点击的，叩谢豪恩。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hackpython.github.io/blog/blog/2019/10/21/%E4%B8%80%E4%BA%BA%E5%88%A9%E7%94%A8%E6%97%A0%E8%81%8A%E7%9A%84%E6%8A%80%E6%9C%AF%E6%9E%84%E5%BB%BA%E5%95%86%E4%B8%9A%E7%BD%91%E7%AB%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/header.jpeg">
      <meta itemprop="name" content="hackpython">
      <meta itemprop="description" content="HackPython，最酷的方式学习python">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HackPython">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/10/21/%E4%B8%80%E4%BA%BA%E5%88%A9%E7%94%A8%E6%97%A0%E8%81%8A%E7%9A%84%E6%8A%80%E6%9C%AF%E6%9E%84%E5%BB%BA%E5%95%86%E4%B8%9A%E7%BD%91%E7%AB%99/" class="post-title-link" itemprop="url">一人利用无聊的技术构建商业网站</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-10-21 16:40:32 / 修改时间：16:46:55" itemprop="dateCreated datePublished" datetime="2019-10-21T16:40:32+08:00">2019-10-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>译自：<a href="https://broadcast.listennotes.com/the-boring-technology-behind-listen-notes-56697c2e347b" target="_blank" rel="noopener">https://broadcast.listennotes.com/the-boring-technology-behind-listen-notes-56697c2e347b</a></p>
<p>看作者如何轻松利用「Django+其他技术」构建一个商业网站。</p>
<h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191018110459.png" alt="" /></p>
<p>Listen Note 是一个播客搜索引擎和数据库。Listen Note背后的技术其实非常简单无聊，没有使用什么人工智能、深度学习或区块链（任何人说自己使用了人工智能技术，他使用的都不是真正的人工智能）。</p>
<blockquote>
<p>播客，也称PodCast，是一种数字媒体，指一系列的音频、影片、电子电台或文字档以列表形式经互联网发布，然后听众经由电子设备订阅该列表以下载或流当中的电子文件，从而接收内容。</p>
</blockquote>
<p>读完这篇文章后，你应该也可以构建一个Listen Notes或者很轻松的做一些类似的事情。</p>
<p>你不需要雇很多员工，还记得Instagram被FaceBook以10亿美元收购的事情吗？当时Instagram才13个员工，而且并非全部都是工程师。</p>
<p>现在比以往任何时候都可能通过一个小型团队(甚至一个人)来构建一些有价值有意义的东西。</p>
<h2 id="listten-notes概览"><a class="markdownIt-Anchor" href="#listten-notes概览"></a> Listten Notes概览</h2>
<p>Listen Notes为用户提供了两样东西。</p>
<ul>
<li>1.一个网站，地址为：<a href="http://listennotes.com" target="_blank" rel="noopener">listennotes.com</a>，它提供了一个搜索引擎、一个播客数据库，还提供了稍后再听、播放列表、听播客片段(它允许你剪辑任何播客界面的一个片段，然后收听)以及播客监听提醒(互联网上的新播客中提到了你指定的关键字，它就会通知你)等功能</li>
<li>2.为开发者提供了播客搜索与目录的API，通过API可以了解用户的使用情况。</li>
</ul>
<p>我在AWS上运行了ListenNotes的所有东西，总共用了20台生产服务器(2019年5月5日为止)</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191018111835.png" alt="" /></p>
<p>从主机名就可以猜出，每个服务器是做什么的</p>
<ul>
<li>1.production-web(生产网服务器)：主要用于提供listennotes.com网络流量服务。</li>
<li>2.production-api(生产api服务器)：主要用于提供API服务，目前我运行了两个版本的API(v1api遗留版api与v2api新版api）</li>
<li>3.production-db(生产数据库)：使用PostgreSQL构建主从数据库</li>
<li>4.production-es(Elasticsearch集群)：主要负责搜索</li>
<li>5.production-worker(工作者)：主要用于运行各种离线任务(爬取最新的播客)，以保持播客数据库始终是最新的，并提供一些其他的小功能。</li>
<li>6.production-lb(负载均衡器)：使用了Redis与RabbitMQ这种简单方式构建（这不是一个理想的方案，但我从来不是一个完美的人)</li>
<li>7.production-pangu(盘古)用于运行一些一次性脚本以及进行测试的机器(这里的盘古就是盘古开天地的盘古，中国文化在国外还是很有吸引力的:))</li>
</ul>
<h2 id="后端"><a class="markdownIt-Anchor" href="#后端"></a> 后端</h2>
<p>整个后端使用 Django/Python3 编写，操作系统是Ubuntu。</p>
<p>使用uWSGI+Nginx来部署Django，Nginx也用来充当负载均衡器(这其实就是常见的Ubuntu+uWSGI+Nginx+Django的部署方案，不了解的，可以搜索一下，可以找到一大堆具体的操作)。</p>
<p>数据库主要使用PostgreSQL，我对PostgreSQL有多年的开发与运营经验，使用的比较好。</p>
<p>Redis用于不同目的，如用于缓存、统计等等</p>
<p>Elasticsearch负责整个网站的搜索，我使用Elasticsearch索引了网站中的播客与剧集，使用方式跟很多无聊的公司一样，没什么可说的。</p>
<p>我使用Celery来调度离线任务，用Supervisord来对服务器上进程进行管理。</p>
<p>为什么不用Docker/Kubernetes/Serverless这些技术？</p>
<p>没有必要，对于中小型公司而言，过度工程化是不好的。实际上，早在2014年，我就为我的雇主做过一些Docker早期的工作，这对于一个规模达到十亿美元的中型创业公司是一件好事，但对我这种一个人的创业公司，可能就有些过了。</p>
<h2 id="前端"><a class="markdownIt-Anchor" href="#前端"></a> 前端</h2>
<p>网站的前端主要使用 React+Redux+WebPack+ES构建，这是现在的标准做法。</p>
<p>当部署到生产环境时，我将JS包导出到Amazon S3上，并通过CloudFront提供CDN服务</p>
<blockquote>
<p>Amazon CloudFront 是由亚马逊网络服务系统提供基础服务的一个内容分发网络（CDN）。其在欧洲、亚洲、北美、澳洲、南美、美国多个主要大城市多地拥有自己的数据中心，共 107 个网络边际服务点提供服务。</p>
</blockquote>
<p>在listennotes.com这个网站上，大多数网页一半使用了Django模块一半使用了React程序。服务器渲染部分提供了web页面的样板，而客户端(浏览器端)部分基本上就是一个交互式web应用程序。</p>
<p>但有一些网页是完全同Django模板渲染呈现的，因为我懒得将事情做得太完美，而且这可能对SEO有一些好处。</p>
<h2 id="音乐播放器"><a class="markdownIt-Anchor" href="#音乐播放器"></a> 音乐播放器</h2>
<p>在listennotes网站上，我使用一个进过大量修改的开源音乐播放器react-media-player，这个播放器我使用在了多个地方，通过iframe简单嵌入在需要的页面就好了，非常简单。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191018114800.png" alt="" /></p>
<blockquote>
<p>react-media-player开源地址：<a href="https://github.com/souporserious/react-media-player" target="_blank" rel="noopener">https://github.com/souporserious/react-media-player</a></p>
</blockquote>
<h2 id="播客api"><a class="markdownIt-Anchor" href="#播客api"></a> 播客API</h2>
<p>listennotes为开发者提供了简单可靠的播客API，构建API类似于构建网站，后端使用了Django/Python来构建，前端使用了ReactJS，效果如下。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191018114954.png" alt="" /></p>
<p>对于API，我们需要跟踪记录使用API的用户在当前计费周期中使用了多少次请求，并在计费周期结束时收取相应的费用。</p>
<h2 id="devops"><a class="markdownIt-Anchor" href="#devops"></a> DevOps</h2>
<h3 id="机器配置与代码部署"><a class="markdownIt-Anchor" href="#机器配置与代码部署"></a> 机器配置与代码部署</h3>
<p>我使用Ansible进行服务器的部署，简单来说就写了一堆yaml文件来指定什么类型的服务器需要声明什么配置文件以及什么软件，下面是这些Ansible yaml文件的目录结构。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191018115219.png" alt="" /></p>
<p>我还使用Ansible将代码部署到生产环境汇总，基本上，我就在MacOS中运行一个部署脚本deploy.sh就可以了。</p>
<blockquote>
<p>Ansible：做Python运维必须知道的一个第三方库，简单而言，Ansible是一个简便的IT自动化引擎，有兴趣可以自行搜索了解一下，其生态丰富，有很多文档可以参考。</p>
</blockquote>
<p>deploy.sh接收3个参数，使用方式如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./deploy.sh</span> production HEAD web</span><br></pre></td></tr></table></figure>
<ul>
<li>1.Envireonment：用于区分你要部署的是生产环境还是staging环境</li>
<li>2.listennotes repo版本：HEAD是只部署最新的版本，如果指定的是git commite中的SHA，那么它就会部署一个特定的版本，这在我需要从一个错误部署中回滚到某个版本的代码来说非常有用。</li>
<li>3.Server kind服务器类型：有web、woker、api等不同服务器类型选择，我不需要同时部署所有的服务器，有时我对JavaScript代码进行了修改，我就只需要将其部署到web上，而不需要改动api与worker类型服务器</li>
</ul>
<blockquote>
<p>staging环境：通常一个web项目都需要一个staging环境，一来给客户做演示，二来可以作为 production server的一个 “预演”，正式发布新功能前能及早发现问题。</p>
</blockquote>
<p>部署的大部分过程由Ansible yaml配置文件精心安排，Ansible会自动去执行完这个流程，当然，这非常简单：</p>
<ul>
<li>1.在我的MacBook Pro上：如果要部署到web服务器上，就自动构建JavaScript包，并上传到Amazon S3上</li>
<li>2.在目标服务器上：通git，将对应的listennotes repo克隆到一个以时间戳命名的文件夹中，检查特定的版本，并通过pip安装新的Python依赖</li>
<li>3.在目标服务器上：将软连接(通过ln命令构建软连接)指向新的时间戳文件夹，并通过supervisorctl重启服务器</li>
</ul>
<p>整个工作我没有使用任何复杂的技术，只是利用了一些简单且实际的技术来实现这样的流程。</p>
<h3 id="监控与报警"><a class="markdownIt-Anchor" href="#监控与报警"></a> 监控与报警</h3>
<p>我使用DataDog服务进行监控与报警，它是一个SaaS服务，所以我并不需要做什么复杂的事情就可以得到一个简单仪表盘，并从中看都我服务器的各种指标。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191018121137.png" alt="" /></p>
<p>我将DataDog链接到PagerDuty，如果出了什么问题，PagerDuty会通过电话与短信的形式提醒我。</p>
<p>此外，我还使用Rollbar来关注Django代码的状况，它会捕捉代码意外产生的异常并通过email或Slack(Slack基于云的专有即时消息传递平台)来通知为通知我。</p>
<blockquote>
<p>Datadog 是云服务应用程序的监控服务，通过基于SaaS的数据分析平台提供对服务器，数据库，工具和服务的监控。<br />
PagerDuty 是一家美国云计算公司为IT部门提供SaaS事件的响应平台。<br />
Rollbar 可以自动化错误监视和筛选，开发人员可以在几分钟内修复重要的错误，并且可以快速、轻松地构建软件。<br />
这些都是SaaS服务，都是要花钱的:(</p>
</blockquote>
<p>我个人经常使用Slack，但公司只有我一个人，所以我不使用Slack与他人交流，而是通过Slack来监控有趣的应用程序级事件。</p>
<p>除了将DataDog和Rollbar与Slack集成，我还在Listen Notes后端代码中使用了Slack传入webhooks(网页钩子)，当用户注册或执行一些操作时，Slack就可以通知到我。</p>
<p>在2017年初推出ListeNote以来，只在2018年4月22日停电事故宕机了一次，那一次ListenNote网站关闭了4个小时，我损失了10个小时的生产数据，是一次重大的打击。此外ListeNote就没有出现过任何中断。</p>
<h2 id="发展"><a class="markdownIt-Anchor" href="#发展"></a> 发展</h2>
<p>我在旧金山的WeWork共享空间工作。</p>
<p>为什么不在家里?</p>
<p>我非常重视生产力，我愿意在生产力上投资，我不认为在家里摸鱼有助于软件开发(或任何类型的知识/创造性工作)。我很少一天工作超过8小时，我珍惜每一分钟。</p>
<p>因此，我需要一个漂亮且相对昂贵的私人办公室，我不愿花更多时间来节省这些钱，而更愿意花费一些钱利用更少的时间来赚钱。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20191018123014.png" alt="" /></p>
<p>我使用MacBook Pro进行开发工作，我在Vagrant+VirtualBox中运行了几乎与线上相同的环境，我同样使用Anserable yaml文件来部署Vagrant内部开发环境。</p>
<p>我将listennote的代码都托管到Github的私有repo中，我在主分支上做所有的开发工作，我很少使用功能分支。</p>
<p>我使用PyCharm编写并运行dev服务(Django runserver 和 webpack dev server)，这很无聊…我没有使用VS Code或Atom或其他很酷的IDE。</p>
<h2 id="保持冷静持续行动"><a class="markdownIt-Anchor" href="#保持冷静持续行动"></a> 保持冷静，持续行动</h2>
<p>正如你所见，我们生活在可以轻松创办公司的美好时代，有那么多现成的工具与服务，可以节省我们的时间和金钱，并提高我们的生产力，现在比以往任何时候都更能让一个小团队或一个人利用一些简单且无聊的技术来构建一些对世界有用的东西。</p>
<p>随着时间的推移，公司会越变越小，你不需要雇佣全职员工，你完全可以通过SaaS以及Upwork上找承包商来完成工作。</p>
<p>大多数时候，阻碍我们行动的就是过度思考，你会想，如果这个…如果那个…，其实你一点都不重要，每个人都在忙于自己的生活，没人关注你创建的东西，除非你证明你值得被别人关注。即使你完全搞砸了最初的产品发布，也很少有人会注意到。</p>
<p>Think big, start small, act fast.</p>
<p>使用一下无聊的技术开始做一些简单的事情是完全可以的，只要你能真正解决问题。</p>
<h2 id="尾"><a class="markdownIt-Anchor" href="#尾"></a> 尾</h2>
<p>国内很多文章都将做个东西描绘的复杂难懂，细节很多，而国外很多文章一上来就会说，这是个简单且无聊的东西，我更喜欢国外文章的氛围，不是说，技术一定都很简单，而是给人树立信息，对自己可以做的事情有信心是很好的事情。</p>
<p>如果我的文章对你有所帮助，请点一下「好看」，这对我这个小号而言非常重要，叩谢豪恩。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hackpython.github.io/blog/blog/2019/07/18/Python%E8%BF%9B%E9%98%B6%EF%BC%9A%E6%B5%85%E6%9E%90%E3%80%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6%E3%80%8D-%E4%B8%8B%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/header.jpeg">
      <meta itemprop="name" content="hackpython">
      <meta itemprop="description" content="HackPython，最酷的方式学习python">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HackPython">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/07/18/Python%E8%BF%9B%E9%98%B6%EF%BC%9A%E6%B5%85%E6%9E%90%E3%80%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6%E3%80%8D-%E4%B8%8B%E7%AF%87/" class="post-title-link" itemprop="url">Python进阶：浅析「垃圾回收机制」(下篇)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-07-18 14:13:59 / 修改时间：14:15:00" itemprop="dateCreated datePublished" datetime="2019-07-18T14:13:59+08:00">2019-07-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>HackPython致力于有趣有价值的编程教学</p>
</blockquote>
<h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>Python垃圾回收机制本质就是对内存的操作机制，当程序需要长时间运行时，其内存的变化就变得关键，如果没有及时释放内存，即Python自动垃圾回收机制因为我们某些代码逻辑上的错误而导致某些内存一直不能被回收，从而造成程序的内存泄露。</p>
<p>Python为GC提供了扩展模块gc，利用gc模块提供的接口，可以查看到垃圾收集器的状态，垃圾收集器收集的对象、被收集对象的详细信息等。</p>
<p>在上篇中，我们简要的讨论了「垃圾回收机制」的原理，本篇则来讨论一下操作层面的内容。</p>
<h2 id="gc模块概况"><a class="markdownIt-Anchor" href="#gc模块概况"></a> gc模块概况</h2>
<p>虽说Python垃圾回收是自动的，不需要人为的干预，但人为干预的情况并不少见，如在游戏公司，为了提高Python运行的效率，Python GC被开发人员手动关闭，再在某些情况下打开，但默认情况下，Python GC通常只会在下面3种情况触发：</p>
<p>😯1.人为手动调用了 gc.coolect()<br />
😯2.GC的计数器到达阈值时<br />
😯3.Python程序退出时</p>
<p>我们可以利用gc模块来操作Python的GC，在具体操作前，先理解其提供方法的大致功能。</p>
<p>😗gc.isenabled() 判断Python程序在当前的状态的下是否已经打开自动垃圾回收机制，如果已经打开，该方法返回True。</p>
<p>😗gc.disable() 该方法用于关闭自动垃圾收集器，关闭自动垃圾收集器后，程序产生的垃圾对象(不可访问的对象)不会被自动回收，会持续的占用内存。</p>
<p>😗gc.collect([generation]) 显式进行垃圾回收，可以输入参数，0 代表只检查第一代的对象，1 代表检查一，二代的对象，2 代表检查一，二，三代的对象，如果不传参数，则启动完全的垃圾回收，也就是等于传 2。该方法会返回不可达对象的个数。</p>
<p>😗gc.set_debug(flags) 将垃圾收集器设置为调试状态，在该状态下，垃圾收集器会打印出收集到的所有对象信息并将不可访问的垃圾对象保存到 gc.garbage 列表中。</p>
<p>😗gc.set_threshold(threshold0[, threshold1[, threshold2])<br />
设置自动执行垃圾回收的频率。</p>
<p>😗gc.garbage列表，列表内部存放着垃圾收回器找到的不可达并且无法被释放的对象，通常这些对象会一直存在到程序结束，如果程序要长时间运行，如果gc.garbage列表中的对象一直在增多，容易造成内存泄露。</p>
<p>😗gc.is_tracked(obj) 该方法用于判断某个变量是否被垃圾回收器监控，如果是，则返回True，否则返回False，通常只有非原子类（如容器、用户自定义对象）会被监控，这是为了避免循环引用的情况出现。</p>
<p>😗gc.get_count() 获取当前自动执行垃圾回收的计数器，返回一个长度为 3 的列表</p>
<p>常用于set_debug()的flags:</p>
<p>🤓gc.DEBUG_STATS<br />
表示打印垃圾回收器回收完后的统计信息，当回收频率较高时，这些信息比较有利。</p>
<p>🤓gc.DEBUG_COLLECTABLE<br />
发现可回收对象时打印信息</p>
<p>🤓gc.DEBUG_UNCOLLECTABLE<br />
打印找到的不可回收对象的信息（指不能被回收器回收的不可达对象）。这些对象会被添加到 gc.garbage 列表中，即不可达又不能被释放的对象</p>
<p>🤓gc.DEBUG_SAVEALL<br />
设置后，所有垃圾回收器找到的不可达对象会被添加进 garbage 而不是直接被释放。这在调试一个内存泄漏的程序时会很有用。</p>
<p>🤓gc.DEBUG_LEAK<br />
调试内存泄漏的程序时，使回收器打印信息的调试标识位。（等价于 DEBUG_COLLECTABLE | DEBUG_UNCOLLECTABLE | DEBUG_SAVEALL ）</p>
<p>更多功能，可以参考官方文档：<a href="https://docs.python.org/zh-cn/3.8/library/gc.html" target="_blank" rel="noopener">gc — 垃圾回收器接口 — Python 3.8.0b2 文档</a></p>
<h2 id="内存泄露"><a class="markdownIt-Anchor" href="#内存泄露"></a> 内存泄露</h2>
<p>我们已经知道Python利用「标记-清除」算法来解决循环引用的情况，但在Python2.7中要依赖于对象的<code>__del__</code>方法，如果该方法被用户自定义了，则「标记-清除」就无法打破循环引用，从而出现不可达且不可释放的垃圾对象，一个具体的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line">		print(<span class="string">'A del'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_leak</span><span class="params">()</span>:</span></span><br><span class="line">	c1 = A()</span><br><span class="line">	c2 = A()</span><br><span class="line">	<span class="comment"># 循环引用</span></span><br><span class="line">	c1.t = c2</span><br><span class="line">	c2.t = c1</span><br><span class="line">	<span class="comment"># 删去</span></span><br><span class="line">	<span class="keyword">del</span> c1</span><br><span class="line">	<span class="keyword">del</span> c2</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	test_leak()</span><br><span class="line">	<span class="comment"># collect() 显示触发垃圾回收，并获得不可达对象个数</span></span><br><span class="line">	print(gc.collect())</span><br><span class="line">	<span class="comment"># 不可释放的个数</span></span><br><span class="line">	print(len(gc.garbage))</span><br><span class="line">	print(gc.garbage)</span><br></pre></td></tr></table></figure>
<p>如果在Python2.7下运行上述代码，输出如下内容：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4</span><br><span class="line">2</span><br><span class="line">[&lt;__main__.A<span class="built_in"> instance </span>at 0x103faea70&gt;, &lt;__main__.A<span class="built_in"> instance </span>at 0x103faeab8&gt;]</span><br></pre></td></tr></table></figure>
<p>可以看出有2个变量是不可释放的，如果这类对象随着程序运行的时长而增加，就容易造成程序的内存泄露，从打印也可以知道，这两个对象是A类实例，而且观察A类中的<code>__del__</code>方法，其中的内容并</p>
<p>但这类问题在Python3.5及以上版本的Python中没有出现(没有测试Python3.5以下版本的Python)，在Python3.7下运行上面程序的结果如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A del</span><br><span class="line">A del</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">[]</span><br></pre></td></tr></table></figure>
<p>从结果可以看出，Python3.7中已经将这一的问题修复了。</p>
<h2 id="python-gc-分代回收使用"><a class="markdownIt-Anchor" href="#python-gc-分代回收使用"></a> Python GC 分代回收使用</h2>
<p>Python为了保证GC的速度，使用了分代回收的策略，即不对变量立刻进行回收，在上篇中提及了其中的原理，在一轮 gc 扫描中存活下来的变量存到对应「代」的列表中，其分为第0代、第1代与第2代，存活到最后，gc扫描的频率就越低，直到触发对应的阈值。</p>
<p>gc 模快有一个自动垃圾回收的阀值，即通过 gc.get_threshold 函数获取到的长度为 3 的元组，其默认值为 (700,10,10)。每一次计数器的增加，gc 模块就会检查增加后的计数是否达到阀值的数目，如果是，就会执行对应的代数的垃圾检查，然后重置计数器<br />
例如，假设阀值是 (700,10,10)：</p>
<p>😳1.当计数器从 (699,8,0) 增加到 (700,8,0)，gc 模块就会执行 gc.collect(0), 即检查 0 代对象的垃圾，并重置计数器为 (0,9,0)</p>
<p>😳2.当计数器从 (699,9,0) 增加到 (700,9,0)，gc 模块就会执行 gc.collect(1), 即检查 1、2 代对象的垃圾，并重置计数器为 (0,0,1)</p>
<p>😳3.当计数器从 (699,9,9) 增加到 (700,9,9)，gc 模块就会执行 gc.collect(2), 即检查 0、1、2 代对象的垃圾，并重置计数器为 (0,0,0)</p>
<p>可以通过set_threshold()函数来设置不同代之间的阈值，从而实现控制gc扫描频率的目的，简单代码如下：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="title">threshold</span> = int(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">A</span>(<span class="title">object</span>):</span></span><br><span class="line"><span class="class">	def __init__(<span class="title">self</span>, <span class="title">name</span>):</span></span><br><span class="line"><span class="class">		self.name = name</span></span><br><span class="line"><span class="class">		print('<span class="type">Create</span>', <span class="title">self</span>.<span class="title">name</span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"># 打印垃圾回收器回收完后的统计信息</span></span><br><span class="line"><span class="class">gc.set_debug(<span class="title">gc</span>.<span class="type">DEBUG_STATS</span>)</span></span><br><span class="line"><span class="class"># 设置分代回收阀值</span></span><br><span class="line"><span class="class">gc.set_threshold(<span class="title">threshold</span>, 1, 1)</span></span><br><span class="line"><span class="class">print('<span class="type">Thresholds</span>:', <span class="title">gc</span>.<span class="title">get_threshold</span>())</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">print('<span class="type">Clear</span> <span class="title">the</span> <span class="title">collector</span> <span class="title">by</span> <span class="title">forcing</span> <span class="title">a</span> <span class="title">run'</span>)</span></span><br><span class="line"><span class="class">gc.collect()</span></span><br><span class="line"><span class="class">print()</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">print('<span class="type">Creating</span> <span class="title">objects'</span>)</span></span><br><span class="line"><span class="class">alist = []</span></span><br><span class="line"><span class="class">for i in range(10):</span></span><br><span class="line"><span class="class">    alist.append(<span class="type">A</span>('<span class="type">A</span>'+<span class="title">str</span>(<span class="title">i</span>)))</span></span><br></pre></td></tr></table></figure>
<p>上述代码中，使用 set_debug()设置gc模块为debug模式，方便查看信息，再利用set_threshold()方法设置分代回收的阀值，从而控制Python GC的频率</p>
<p>简单使用一下，首先将分代回收阈值设置为 (100,1,1)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">python</span> <span class="string">-u</span> <span class="string">test4.py</span> <span class="number">100</span></span><br><span class="line"><span class="attr">Thresholds:</span> <span class="string">(100,</span> <span class="number">1</span><span class="string">,</span> <span class="number">1</span><span class="string">)</span></span><br><span class="line"><span class="string">Clear</span> <span class="string">the</span> <span class="string">collector</span> <span class="string">by</span> <span class="string">forcing</span> <span class="string">a</span> <span class="string">run</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">2</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">574</span> <span class="number">3814</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0004s</span> <span class="string">elapsed</span></span><br><span class="line"></span><br><span class="line"><span class="string">Creating</span> <span class="string">objects</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A0</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A1</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A2</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A3</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A4</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A5</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A6</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A7</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A8</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A9</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">2</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">11</span> <span class="number">0</span> <span class="number">4260</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0004s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">2</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">66</span> <span class="number">0</span> <span class="number">4177</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">589</span> <span class="string">unreachable,</span> <span class="number">0</span> <span class="string">uncollectable,</span> <span class="number">0.</span><span class="string">0005s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">2</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3029</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">151</span> <span class="string">unreachable,</span> <span class="number">0</span> <span class="string">uncollectable,</span> <span class="number">0.</span><span class="string">0002s</span> <span class="string">elapsed</span></span><br></pre></td></tr></table></figure>
<p>接着将其设置小一些</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">python</span> <span class="string">-u</span> <span class="string">test4.py</span> <span class="number">2</span></span><br><span class="line"><span class="attr">Thresholds:</span> <span class="string">(2,</span> <span class="number">1</span><span class="string">,</span> <span class="number">1</span><span class="string">)</span></span><br><span class="line"><span class="string">Clear</span> <span class="string">the</span> <span class="string">collector</span> <span class="string">by</span> <span class="string">forcing</span> <span class="string">a</span> <span class="string">run</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">2</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">574</span> <span class="number">3814</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0004s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">1</span> <span class="number">0</span> <span class="number">4261</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"></span><br><span class="line"><span class="string">Creating</span> <span class="string">objects</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">3</span> <span class="number">0</span> <span class="number">4261</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">1</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4261</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A1</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A2</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">2</span> <span class="number">0</span> <span class="number">4264</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A3</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">3</span> <span class="number">1</span> <span class="number">4264</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A4</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A5</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">1</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4264</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A6</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">3</span> <span class="number">0</span> <span class="number">4268</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A7</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A8</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4268</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="string">Create</span> <span class="string">A9</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">2</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">1</span> <span class="number">3</span> <span class="number">4267</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0003s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">5</span> <span class="number">0</span> <span class="number">4216</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4216</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">1</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">6</span> <span class="number">11</span> <span class="number">4216</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">6</span> <span class="number">0</span> <span class="number">4233</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">8</span> <span class="number">6</span> <span class="number">4232</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">1</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">6</span> <span class="number">14</span> <span class="number">4232</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">10</span> <span class="number">0</span> <span class="number">4245</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">4</span> <span class="number">10</span> <span class="number">4244</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">1</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">3</span> <span class="number">14</span> <span class="number">4244</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">3</span> <span class="number">0</span> <span class="number">4261</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">0</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">3</span> <span class="number">3</span> <span class="number">4261</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">1</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">4</span> <span class="number">6</span> <span class="number">4260</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">0.</span><span class="string">0000s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">2</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">2</span> <span class="number">0</span> <span class="number">4241</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">589</span> <span class="string">unreachable,</span> <span class="number">0</span> <span class="string">uncollectable,</span> <span class="number">0.</span><span class="string">0004s</span> <span class="string">elapsed</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">collecting</span> <span class="string">generation</span> <span class="number">2</span><span class="string">...</span></span><br><span class="line"><span class="attr">gc: objects in each generation:</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3029</span></span><br><span class="line"><span class="attr">gc: objects in permanent generation:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">gc:</span> <span class="string">done,</span> <span class="number">151</span> <span class="string">unreachable,</span> <span class="number">0</span> <span class="string">uncollectable,</span> <span class="number">0.</span><span class="string">0002s</span> <span class="string">elapsed</span></span><br></pre></td></tr></table></figure>
<p>从打印可以看出，将分代回收阈值设置为(2,1,1)后，Python GC执行的频率明显更频繁，但这会在一定程度上影响程序的效率。</p>
<h2 id="禁用gc调高速度"><a class="markdownIt-Anchor" href="#禁用gc调高速度"></a> 禁用GC调高速度</h2>
<p>从前面的介绍可知，Python的引用计数会在每个内存对象中都存在一个计数变量，当有大量的对象新建或删除时，就会涉及到该变量的大量修改，从而影响程序的性能，为了避免这种情况，在程序进行大量对象新建或删除前，可以先将GC禁用，等这些操作结束后，再开启GC，例子如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import gc</span><br><span class="line"><span class="comment"># 关闭GC</span></span><br><span class="line">gc.<span class="builtin-name">disable</span>()</span><br><span class="line"><span class="comment"># do something</span></span><br><span class="line"><span class="comment"># 开启GC</span></span><br><span class="line">gc.<span class="builtin-name">enable</span>()</span><br><span class="line"><span class="comment"># 手动执行GC</span></span><br><span class="line">gc.collect()</span><br></pre></td></tr></table></figure>
<p>此时就会在批量操作后，对这些变量进行批量的回收。</p>
<h2 id="结尾"><a class="markdownIt-Anchor" href="#结尾"></a> 结尾</h2>
<p>本节主要讨论了Python中的gc模块并简单的使用了该模块，</p>
<p>本节中简单的讨论了Python中的垃圾回收机制，那是否有某些手段可以比较直观的看出当前项目中Python GC的使用情况，从而可以直观的判断项目对内存的使用是否合理呢？这些内容会尝试在浅析「垃圾回收机制」下篇中讨论😏，最后欢迎学习 HackPython 的教学课程并感觉您的阅读与支持。</p>
<p>👋👋</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hackpython.github.io/blog/blog/2019/07/05/Python%E8%BF%9B%E9%98%B6%EF%BC%9A%E6%B5%85%E6%9E%90%E3%80%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6%E3%80%8D-%E4%B8%8A%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/header.jpeg">
      <meta itemprop="name" content="hackpython">
      <meta itemprop="description" content="HackPython，最酷的方式学习python">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HackPython">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/07/05/Python%E8%BF%9B%E9%98%B6%EF%BC%9A%E6%B5%85%E6%9E%90%E3%80%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6%E3%80%8D-%E4%B8%8A%E7%AF%87/" class="post-title-link" itemprop="url">Python进阶：浅析「垃圾回收机制」(上篇)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-07-05 22:34:00 / 修改时间：22:46:19" itemprop="dateCreated datePublished" datetime="2019-07-05T22:34:00+08:00">2019-07-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>HackPython致力于有趣有价值的编程教学</p>
</blockquote>
<h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>Python垃圾回收机制是很多Python岗位面试官喜欢提的一点🙃，虽然Python具有垃圾自动回收的机制，但在一些大型项目中有些资源是不能等到它自动回收的，而需要手动将使用完的资源回收释放，从而让程序尽可能的耗尽服务器的所有资源，这在游戏开发中很重要，服务器是需要成本的🤨。</p>
<p>Python中垃圾回收机制(Garbage Collection, GC)主要使用「引用计数」进行垃圾回收，通过「标记-清理」解决「容器对象」产生循环引用的问题，在通过「分代回收」以空间换时间的方式来提高垃圾回收的效率。</p>
<p>下面分别从「引用计数」、「标记-清理」以及「分代回收」来讨论一下Python中的GC。</p>
<h2 id="引用计数"><a class="markdownIt-Anchor" href="#引用计数"></a> 引用计数</h2>
<p>从CPython源码中，Python对象的核心是PyObject这个结构体😗，该结构体内存通过ob_refcnt实现变量的引用计数，PyObject结构体如下:</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> typedef struct_object &#123;</span><br><span class="line">    int ob_refcnt<span class="comment">;</span></span><br><span class="line">    struct_typeobject *ob_type<span class="comment">;</span></span><br><span class="line">&#125; PyObject<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>程序在运行的过程中会实时的更新 ob_refcnt 的值，来反映引用当前对象的名称数量。当某对象的引用计数值为 0, 那么它的内存就会被立即释放掉，即被垃圾回收。</p>
<p>以下情况是导致引用计数加一的情况:</p>
<p>😀1.对象被创建，例如 a=2333<br />
😀2.对象被引用，b=a<br />
😀3.对象被作为参数，传入到一个函数中<br />
😀4.对象作为一个元素，存储在容器中</p>
<p>下面的情况则会导致引用计数减一:</p>
<p>🙁1.对象别名被显示销毁 del<br />
🙁2.对象别名被赋予新的对象<br />
🙁3.一个对象离开他的作用域<br />
🙁4.对象所在的容器被销毁或者是从容器中删除对象</p>
<p>可以通过 sys 包中的 getrefcount() 来获取一个名称所引用的对象当前的引用计数 (注意，这里 getrefcount () 本身会使得引用计数加一)</p>
<p>「引用计数」这种方式很容易从逻辑层面去理解，简单而言就是有人用旧留着，没人用就回收，但这种方式是比较耗费资源的，毕竟计数也需要占用内存，而且该方法无法解决「容器对象」循环引用的问题，如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a=[<span class="number">1</span>,<span class="number">2</span>] # 计数为 <span class="number">1</span></span><br><span class="line">b=[<span class="number">2</span>,<span class="number">3</span>] # 计数为 <span class="number">1</span></span><br><span class="line">a.append(b) # 计数为 <span class="number">2</span></span><br><span class="line">b.append(a) # 计数为 <span class="number">2</span></span><br><span class="line">DEL a # 计数为 <span class="number">1</span></span><br><span class="line">DEL b # 计数为 <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>循环引用导致变量计数永不为0，造成引用计数无法将其删除。</p>
<h2 id="标记-清除"><a class="markdownIt-Anchor" href="#标记-清除"></a> 标记-清除</h2>
<p>Python 中使用标记-清除的方式来解决循环引用导致的问题。</p>
<p>只有容器对象才会产生循环引用的情况，比如列表、字典、用户自定义类的对象、元组等。而像数字，字符串这类简单类型不会出现循环引用。</p>
<p>「标记-清除」作为一种优化策略，对于只包含简单类型的元组也不在标记清除算法的考虑之列，简单来看，「标记-清除」算法在进行垃圾回收时分成了两步，分别是：</p>
<p>🤫A）标记阶段，遍历所有的对象，如果是可达的（reachable），也就是还有对象引用它，那么就标记该对象为可达；<br />
🤫B）清除阶段，再次遍历对象，如果发现某个对象没有标记为可达，则就将其回收。</p>
<p>下面看图来理解 标记-清除 ，图片出自 <a href="https://andrewpqc.github.io/2018/10/08/python-memory-management/" target="_blank" rel="noopener">聊聊 Python 内存管理</a></p>
<p>在标记清除算法中，为了追踪容器对象，需要每个容器对象维护两个额外的指针，用来将容器对象组成一个双端链表，指针分别指向前后两个容器对象，方便插入和删除操作😎。python 解释器 (Cpython) 维护了两个这样的双端链表，一个链表存放着需要被扫描的容器对象，称为 Object to Scan，另一个链表存放着临时不可达对象，称为 Unreachable。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20190705224034.png" alt="" /></p>
<p>上图中 link1,link2,link3 组成一个引用环，此外 link1 还被变量 A 引用，看图中 link1 被几个箭头指着就知道了，其中 ref_count 记录当前对象的引用计数，而 gc_ref 在一开始，gc_ref 只是 ref_count 的副本，所以 gc_ref 的初始值等于 ref_count。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20190705224055.png" alt="" /></p>
<p>gc 启动的时候，会逐个遍历”Object to Scan” 链表中的容器对象，并且将当前对象所引用的所有对象的 gc_ref 减一😐。这一步操作就相当于解除了循环引用对引用计数的影响。如 link4 是自己引用了自己造成了循环引用，此时 link4 的 gc_ref 为 0.</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20190705224111.png" alt="" /></p>
<p>接着，gc 会再次扫描所有的容器对象，如果对象的 gc_ref 值为 0，且引用该对象的对象其 gc_ref 也为 0 ，那么这个对象就被标记为 GC_TENTATIVELY_UNREACHABLE，并且被移至”Unreachable” 链表中😐。下图中的 link3 和 link4 就是这样一种情况。</p>
<p><img src="https://raw.githubusercontent.com/ayuLiao/images/master/20190705224126.png" alt="" /></p>
<p>如果对象的 gc_ref 不为 0，那么这个对象就会被标记为 GC_REACHABLE😐。同时当 gc 发现有一个节点是可达的，那么他会递归式的将从该节点出发可以到达的所有节点标记为 GC_REACHABLE, 这就是下图中 link2 和 link3 所碰到的情形😯。除了将所有可达节点标记为 GC_REACHABLE 之外，如果该节点当前在”Unreachable” 链表中的话，还需要将其移回到”Object to Scan” 链表中，下图就是 link3 移回之后的情形。</p>
<p>第二次遍历的所有对象都遍历完成之后，存在于”Unreachable” 链表中的对象就是真正需要被释放的对象。如上图所示，此时 link4 存在于 Unreachable 链表中，gc 随即释放之。</p>
<p>上面描述的垃圾回收的阶段，会暂停整个应用程序，等待标记清除结束后才会恢复应用程序的运行🙂。</p>
<h2 id="分代回收"><a class="markdownIt-Anchor" href="#分代回收"></a> 分代回收</h2>
<p>引用计数 + 标记-清除 的方式实现了Python垃圾回收，但整个过程比较慢，而且在 标记-清除 过程中还需要暂停整个程序，为了减少应用程序暂停使用，Python利用分代回收(Generational Collection)以空间换时间的方式来提高垃圾回收效率😯。</p>
<p>分代回收是基于这样的一个统计事实，对于程序，存在一定比例的内存块的生存周期比较短；而剩下的内存块，生存周期会比较长，甚至会从程序开始一直持续到程序结束。生存期较短对象的比例通常在 80%～90% 之间，这种思想简单点说就是：对象存在时间越长，越可能不是垃圾，应该越少去收集🤯。这样在执行标记 - 清除算法时可以有效减小遍历的对象数，从而提高垃圾回收的速度。</p>
<p>python gc 给对象定义了三种世代 (0,1,2), 每一个新生对象在 generation zero 中，如果它在一轮 gc 扫描中活了下来，那么它将被移至 generation one, 在那里他将较少的被扫描，如果它又活过了一轮 gc, 它又将被移至 generation two，在那里它被扫描的次数将会更少🤔。</p>
<p>当某一世代被分配的对象与被释放的对象之差达到某一阈值的时候，就会触发 gc 对某一世代的扫描。值得注意的是当某一世代的扫描被触发的时候，比该世代年轻的世代也会被扫描😯。也就是说如果世代 2 的 gc 扫描被触发了，那么世代 0, 世代 1 也将被扫描，如果世代 1 的 gc 扫描被触发，世代 0 也会被扫描。</p>
<p>该阈值可以通过下面两个函数查看和调整:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import gc</span><br><span class="line">gc.get<span class="constructor">_threshold()</span> # (threshold0, threshold1, threshold2).</span><br><span class="line">gc.set<span class="constructor">_threshold(<span class="params">threshold0</span>[, <span class="params">threshold1</span>[, <span class="params">threshold2</span>]])</span></span><br></pre></td></tr></table></figure>
<p>gc 会记录自从上次收集以来新分配的对象数量与释放的对象数量，当两者之差超过 threshold0 的值时，gc 的扫描就会启动，初始的时候只有世代 0 被检查。如果自从世代 1 最近一次被检查以来，世代 0 被检查超过 threshold1 次，那么对世代 1 的检查将被触发。相同的，如果自从世代 2 最近一次被检查以来，世代 1 被检查超过 threshold2 次，那么对世代 2 的检查将被触发。</p>
<h2 id="结尾"><a class="markdownIt-Anchor" href="#结尾"></a> 结尾</h2>
<p>本节中简单的讨论了Python中的垃圾回收机制，那是否有某些手段可以比较直观的看出当前项目中Python GC的使用情况，从而可以直观的判断项目对内存的使用是否合理呢？这些内容会尝试在浅析「垃圾回收机制」下篇中讨论😏，最后欢迎学习 HackPython 的教学课程并感觉您的阅读与支持。</p>
<p>👋👋</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hackpython.github.io/blog/blog/2019/07/05/Python%E8%BF%9B%E9%98%B6%EF%BC%9A%E7%99%BE%E4%B8%87%E3%80%8C%E5%B9%B6%E5%8F%91%E3%80%8D%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8B%E7%AF%87%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/header.jpeg">
      <meta itemprop="name" content="hackpython">
      <meta itemprop="description" content="HackPython，最酷的方式学习python">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HackPython">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/07/05/Python%E8%BF%9B%E9%98%B6%EF%BC%9A%E7%99%BE%E4%B8%87%E3%80%8C%E5%B9%B6%E5%8F%91%E3%80%8D%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8B%E7%AF%87%EF%BC%89/" class="post-title-link" itemprop="url">Python进阶：百万「并发」基础之异步编程（下篇）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2019-07-05 22:33:46 / 修改时间：22:35:09" itemprop="dateCreated datePublished" datetime="2019-07-05T22:33:46+08:00">2019-07-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>HackPython致力于有趣有价值的编程教学</p>
</blockquote>
<h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>在上一节中，了解了yield、yield from等概念，此时Python以及具有编写协程实现「回调」的能力，而「回调」是异步编程的基础，随后Python语言的开发者利用yield from能力，在Python3.4中引入了异步I/O框架asyncio，该框架在Python3.5中被完善并作为标准库之一，用于基于协程的异步I/O编程，本节就来讨论一下asyncio以及async/await等内容。</p>
<h2 id="关键概念"><a class="markdownIt-Anchor" href="#关键概念"></a> 关键概念</h2>
<p>在Python3.4中引入了asyncio.coroutine装饰器来标志函数作为协程函数，协程函数具有协程的特性并与asyncio的事件循环一同使用，实现异步编程的目的，为了避免生成器与协程之间的混淆，在Python3.5中引入了async/await，其中async替代asyncio.coroutine装饰器，await替代yield from，从而让协程的实现更加直观，async/await和yield frome这两种不同风格的协程在底层其实是相互复用相互兼容的，在Python3.6中asyncio库“转正”，成为正式的标注库。</p>
<p>这里只讨论新的写法，即async/await实现协程的方式，Python中协程主要的特性如下：</p>
<p>😀1.函数使用了async表达式开头，即使它不包含await表达式，也是一个协程函数<br />
😀2.async协程函数中使用yield或者yield from会阐释SyntaxError错误，即新旧语法不可混合使用<br />
😀3.与常规生成器类似，协程函数在调用时会返回一个coroutine对象<br />
😀4.与yield方式实现的协程不同，yield在最后会抛出Stoplteration异常，而async中则是RuntimeError<br />
😀5.当async创建的协程函数被垃圾回收时，一个未被await的协程会抛出RuntimeWarning异常。</p>
<p>在使用asyncio框架前，需要先了解其中几个概念。</p>
<h2 id="coroutine-协程"><a class="markdownIt-Anchor" href="#coroutine-协程"></a> Coroutine 协程</h2>
<p>以async表达式开头的函数成为协程函数或简称为协程，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'hello'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'world'</span>)</span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>
<p>上述代码中，main() 为协程函数，其写法是Python3.7的写法，Python3.7中对asyncio的使用做了简化，😑如果你使用python3.6为主，其asyncio写法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'hello'</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'world'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 创建协程对象</span></span><br><span class="line">    coroutine = main()</span><br><span class="line">    <span class="comment"># 创建事件循环</span></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    <span class="comment"># 将协程对象添加到事件循环中，运行直到结束</span></span><br><span class="line">    loop.run_until_complete(coroutine)</span><br><span class="line">    <span class="comment"># 关闭事件循环</span></span><br><span class="line">    loop.close()</span><br><span class="line"></span><br><span class="line">run()</span><br></pre></td></tr></table></figure>
<p>可以看出，Python3.6中asyncio的用法会复杂一下，在Python3.7中，run()方法已经为我们处理好了创建事件、添加协程对象到事件循环、关闭事件循环等事情😏，即</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">loop asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(main())</span><br><span class="line">loop.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在Python3.7中被替换为</span></span><br><span class="line"></span><br><span class="line">asyncio.run()</span><br></pre></td></tr></table></figure>
<p>当然，asyncio也支持传统的基于生成器的协程，不再多提。</p>
<h2 id="awaitables-可等待对象"><a class="markdownIt-Anchor" href="#awaitables-可等待对象"></a> Awaitables 可等待对象</h2>
<p>「可等待对象」通常有3类，分别是：</p>
<p>😗1.协程 coroutine<br />
😗2.任务 Task<br />
😗3.未来对象 Future</p>
<p>一个直观的判断方法就是，如果一个对象能够被用在 await 表达式中，那么就可以称这个对象为 「可等待对象」</p>
<p>简单示例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">myprint</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'hello hackpython'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 直接调用，创建协程对象，不会执行协程中的内容</span></span><br><span class="line">    myprint()</span><br><span class="line">    <span class="comment"># 协程对象成为被等待对象后，才会执行其中的内容</span></span><br><span class="line">    <span class="keyword">await</span> myprint()</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>
<p>上述代码会输出如下内容：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use_asyncio4.py:8: RuntimeWarning: coroutine <span class="string">'myprint'</span> was never awaited</span><br><span class="line">  myprint()</span><br><span class="line">RuntimeWarning: <span class="builtin-name">Enable</span> tracemalloc <span class="keyword">to</span> <span class="builtin-name">get</span> the object allocation traceback</span><br><span class="line"></span><br><span class="line">hello hackpython</span><br></pre></td></tr></table></figure>
<p>从输入内容可以看出，直接使用协程函数是不会执行其中的逻辑的，而且还会因为没有使用而触发相应的警告，😀只有利用await成为可等待对象后，才会被asyncio事件循环去执行。await会将控制权交由可等待对象。</p>
<h2 id="task-任务"><a class="markdownIt-Anchor" href="#task-任务"></a> Task 任务</h2>
<p>「任务」主要用于「并发」的调度协程。</p>
<p>一个协程可以通过asyncio.create_task()函数封装成一个Task，此时这个协程很快就会被自动调度执行，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fun1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'hackpython'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 创建任务</span></span><br><span class="line">    task = asyncio.create_task(fun1())</span><br><span class="line">    <span class="comment"># 作为被等待对象</span></span><br><span class="line">    <span class="keyword">await</span> task</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>
<p>asyncio.create_task() 是 Python 3.7 新增的方法，如果是Python3.6还可以用 asyncio.ensure_future 和 loop.create_task🤔。</p>
<p>可以将Task理解为协程对象的进一步封装，其中包含着各种状态，简单使用如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'a funtion start.'</span>)</span><br><span class="line">    <span class="keyword">await</span>  asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">'a function end.'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># task = asyncio.ensure_future(a())</span></span><br><span class="line">    task = asyncio.create_task(a())</span><br><span class="line">    print(task)</span><br><span class="line">    print(task.done())</span><br><span class="line">    <span class="keyword">await</span> task</span><br><span class="line">    print(task)</span><br><span class="line">    print(task.done())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>
<p>上述代码输出如下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">Task</span> pending coro=&lt;a() running at <span class="regexp">/Users/</span>ayuliao<span class="regexp">/Desktop/</span>spider<span class="regexp">/lianjia/u</span>se_asyncio1.py:<span class="number">3</span>&gt;&gt;</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line">a funtion start.</span><br><span class="line">a function end.</span><br><span class="line">&lt;<span class="keyword">Task</span> finished coro=&lt;a() done, defined at <span class="regexp">/Users/</span>ayuliao<span class="regexp">/Desktop/</span>spider<span class="regexp">/lianjia/u</span>se_asyncio1.py:<span class="number">3</span>&gt; result=None&gt;</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>从输出内容可以看出，一开始Task任务的状态为pending(等待状态)，调用其done()方法可以判断该任务是否执行😳，可以看出，没有利用await将其转为可等待对象前，Task任务是没有执行的，使用await后，即将控制权交由task对象，此时再次打印，发现其状态改变为finshed(完成状态)，调用done()方法后可得该任务被正常执行了😑。</p>
<h2 id="future-未来对象"><a class="markdownIt-Anchor" href="#future-未来对象"></a> Future 未来对象</h2>
<p>Future代表着一个未来对象，当异步操作结束后会将最终的结果设置到Future对象上，Future同样是对协程的封装，它是一个偏底层的类，具有比较多的方法可以做一些复杂的操作，但在日常开发时，并不会去使用🤭，更多的是使用其Task任务，它其实是Future的一个子类🤭。</p>
<h2 id="eventloop事件循环"><a class="markdownIt-Anchor" href="#eventloop事件循环"></a> Eventloop事件循环</h2>
<p>使用 asyncio 框架时，其实就是开启一个事件循环，事件循环对应的实例提供了注册、取消、执行与回调等方法，方便控制整个事件循环实例。</p>
<p>所谓事件循环，就是将协程函数、任务 Task、未来对象 Future 等注册到事件循环中，事件循环实例会循环执行这些函数😐，注意同一时刻下只执行某个函数对象，具体执行某个函数时，如果执行到函数中进行 I/O 耗时操作的部分，事件循环就会将该函数暂停，而去执行其他函数，等进行 I/O 耗时操作的函数执行完后，会再次加入循环队列，等事件循环下次循环到它时继续从此前位置执行，从而实现这些可异步操作对象的协同运行，达到并发的效果😲。</p>
<h2 id="结尾"><a class="markdownIt-Anchor" href="#结尾"></a> 结尾</h2>
<p>asyncio是Python中比较复杂但又非常重要的概念，在 百万「并发」基础之异步编程 上、中、下三篇文章中比较系统的讨论了异步编程的概念以及在Python中的实现方式😏，但对生成器、yield from以及asyncio等依旧没有深入探讨🤯，在HackPython后面的文章中，会系统性讨论这些概念，最后欢迎学习 HackPython 的教学课程并感觉您的阅读与支持。</p>
<p>👋👋</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/blog/">1</a><a class="page-number" href="/blog/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/blog/page/4/">4</a><a class="extend next" rel="next" href="/blog/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="hackpython"
      src="/blog/images/header.jpeg">
  <p class="site-author-name" itemprop="name">hackpython</p>
  <div class="site-description" itemprop="description">HackPython，最酷的方式学习python</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hackpython" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hackpython" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hackpython</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

<div class="powered-by">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <i class="fa fa-user-md"></i>
    <span id="busuanzi_container_site_uv">
        本站访客数:<span id="busuanzi_value_site_uv"></span>
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_pv">
        本站访问量<span id="busuanzi_value_site_pv"></span>
    </span>
</div>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








        
      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/blog/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>
<script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script>
<script src="/blog/js/schemes/pisces.js"></script>
<script src="/blog/js/next-boot.js"></script>



  




  <script src="/blog/js/local-search.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->













  

  

  

</body>
</html>
